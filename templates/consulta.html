{% extends "base.html" %}
{% load i18n %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/bootstrap-multiselect.css" type="text/css"/>
{% endblock %}

{% block content %}
<style media="screen">
.labels {
  color: black;
  font-family: "Roboto", sans-serif;
  font-size: 12px;
  text-align: center;
  width: auto;
  white-space: nowrap;
  margin-left: -18px !important;
  margin-top: -35px !important;
  padding: -2px;
  border-radius: 15px
}
.service_tiem {
  display: block;
  border: 1px solid #ccc;
  min-height: none !important;
  height: 225px;
}
.service_tiem h2 {
  height: auto !important;
}
.dropdown-menu {
  max-height: 250px;
  overflow-y: auto;
  overflow-x: hidden;
}
</style>
<!-- CONTACT Section
================================================== -->
<div class="metodologia" id="consulta">
  <div class="container">
    <div class="head_section">
      <h2>{% trans "EXPLORAR DATOS" %}</h2>

    </div>
  </div>
  <div class="contact_wrap">
    {% if centinela == 1 %}
    <style type="text/css">
    .cerrar{display: none}

    </style>
    <!-- Service Section
    ================================================== -->
    <div class="" id="services">
      <div class="container">
        <div class="row">
          <div class="col-md-3 col-sm-6">
            <a href="/species/nutritional-group-by-community/" class="service_tiem">
              <!-- <div class="sicon"><i class="fa fa-cogs"></i></div> -->
              <h2>{% trans "Especies por Grupo Nutricionales por Comunidad" %}</h2>
              <p>{% blocktrans %}Cuales grupos nutricionales están bien representados en una comunidad? Cuales grupos nutricionales están bajo representados?{% endblocktrans %}</p>
            </a>
          </div>
          <div class="col-md-3 col-sm-6">
            <a href="/species/nutritional-group-by-country/" class="service_tiem">
              <!-- <div class="sicon"><i class="fa fa-cogs"></i></div> -->
              <h2>{% trans "Especies por Grupo Nutricional por País" %}</h2>
              <p>{% blocktrans %}Cuales grupos nutricionales están bien representados en un país? Cuales grupos nutricionales están bajo representados?{% endblocktrans %}</p>
            </a>
          </div>
          <div class="col-md-3 col-sm-6">

            <a href="/species/number-of-species/" class="service_tiem">
              <!-- <div class="sicon"><i class="fa fa-cogs"></i></div> -->
              <h2>{% trans "Total de Especies" %}</h2>
              <p>{% blocktrans %}Cuantas especies se consume, se produce, se adquiere y se vende en una comunidad?{% endblocktrans %}</p>
            </a>
          </div>
          <div class="col-md-3 col-sm-6">
            <a href="/species/relationship-between-number-of-species-environmental-and-economic-factors/" class="service_tiem">
              <!-- <div class="sicon"><i class="fa fa-cogs"></i></div> -->
              <h2>{% trans "Relación entre número especies, factores ambientales y económicos" %}</h2>
              <p>{% blocktrans %}Que son los dinámicos entre el número de especies usadas y factores ambientales y económicos?{% endblocktrans %}</p>
            </a>
          </div>
          <div class="col-md-3 col-sm-6">
            <a href="/species/profile-spicies/" class="service_tiem">
              <!-- <div class="sicon"><i class="fa fa-cogs"></i></div> -->
              <h2>{% trans "Perfil de Especies" %}</h2>
              <p>{% blocktrans %}Información detallada sobre las especies usadas en las comunidades seleccionadas{% endblocktrans %}</p>
            </a>
          </div>
          <div class="col-md-3 col-sm-6">
            <a href="/species/profile-focus-groups/" class="service_tiem">
              <!-- <div class="sicon"><i class="fa fa-cogs"></i></div> -->
              <h2>{% trans "Perfil de Grupos Focales" %}</h2>
              <p>{% blocktrans %}Información detallada sobre los grupos focales de las comunidades seleccionadas{% endblocktrans %}</p>
            </a>
          </div>
          <div class="col-md-3 col-sm-6">
            <a href="/species/tables-abd/" class="service_tiem">
              <!-- <div class="sicon"><i class="fa fa-cogs"></i></div> -->
              <h2>{% trans "Tablas ABD" %}</h2>
              <p>{% blocktrans %}Para cada especie, cuantas hogares consume, produce, adquiere o vende esta especies? Cuál es la frecuencia de consumo, adquisición y venta de cada especie? Cuál es el tamaño del área de producción de cada especie?{% endblocktrans %}</p>
            </a>
          </div>
          <div class="col-md-3 col-sm-6">
            <a href="/species/profile-abd/" class="service_tiem">
              <!-- <div class="sicon"><i class="fa fa-cogs"></i></div> -->
              <h2>{% trans "Perfil ABD" %}</h2>
              <p>{% blocktrans %}Resumen total del uso de las especies usadas en la comunidad{% endblocktrans %}</p>
            </a>
          </div>
        </div>
      </div>

    </div>

    {% endif %}
    <div class="container cerrar">
      <div class="row">
        <div class="col-sm-6">
          <div class="query form-consulta">
            <h3>{% trans "FILTRO DE DATOS" %}</h3>
            {% if centinela == 0 %}<p class="text-danger">{% trans "Los campos con (*) son requeridos" %}</p>{% endif %}
            <form name="mailform" id="mailform" action="." method="post" enctype="multipart/form-data" >{% csrf_token %}

              <div class="form-group row">
                <label for="inputEmail3" class="col-sm-12 col-lg-4 control-label">
                  {% trans "Región Geográfica" %} *
                </label>
                <div class="col-sm-12 col-lg-8">
                  {{form.region}}
                </div>
              </div>
              <div class="form-group row">
                <label for="inputEmail3" class="col-sm-12 col-lg-4 control-label">
                  {% trans "País" %} *
                </label>
                <div class="col-sm-12 col-lg-8">
                  {{form.country}}
                </div>
              </div>
              <div class="form-group row">
                <label for="inputEmail3" class="col-sm-12 col-lg-4 control-label">
                  {% trans "Provincia" %} *
                </label>
                <div class="col-sm-12 col-lg-8">
                  {{form.province}}
                </div>
              </div>
              <!--<div class="form-group row">
              <label for="inputEmail3" class="col-sm-12 col-lg-4 control-label">
              Estado
            </label>
            <div class="col-sm-12 col-lg-8">
            {{form.county}}
          </div>
        </div>-->
        <div class="form-group row">
          <label for="inputEmail3" class="col-sm-12 col-lg-4 control-label">
            {% trans "Comunidad" %} *
          </label>
          <div class="col-sm-12 col-lg-8">
            {{form.community}}
          </div>
        </div>

        <!--<div class="form-group row">
        <label for="inputEmail3" class="col-sm-12 col-lg-4 control-label">
        {% trans "Año" %}
      </label>
      <div class="col-sm-12 col-lg-8">
      {{form.year}}
    </div>
  </div>-->
  <!--<div class="form-group row">
  <label for="inputEmail3" class="col-sm-12 col-lg-4 control-label">
  Género
</label>
<div class="col-sm-12 col-lg-8">
{{form.gender}}
</div>
</div>-->
<div class="error"></div>
<input type="submit" name="consulta" value="{% trans 'CONSULTAR' %}" class="submit-btn" onClick="ValiDate()">
</form>
</div>
</div>
<div class="col-sm-6">
  <div class="form-inline pull-right f-mapa">
    <div class="form-group">
      <label for="exampleInputName2">{% trans "Filtro de Población" %}</label>
      <select class="form-control" id="select-pais" name='pais'>
        <option value=''>-------</option>
        {% for obj in paises %}
        <option value='{{obj.id}}'>{{obj.name}}</option>
        {% endfor %}
      </select>
    </div>


  </div>

  <div id="map_canvas" class="map" style="width:100%; height:430px"></div>
  <iframe id="fake-map" src="https://www.google.com/maps/embed?pb=!1m10!1m8!1m3!1d52491780.825310744!2d-8.517101532792102!3d17.265583516212416!3m2!1i1024!2i768!4f13.1!5e0!3m2!1ses-419!2sni!4v1466710021328" width="100%" height="430" frameborder="0" style="border:0" allowfullscreen></iframe>
</div>
</div>

<style media="screen">
.table-responsive {
  margin-top: 20px;
  height: 300px !important;
  overflow: scroll;
}
</style>
</div>
</div>
</div>
</div>
<!-- / contact Close -->
{% endblock %}

{% block extra_js %}
<script type="text/javascript" src="/static/js/bootstrap-multiselect.js"></script>
<script type="text/javascript" src="/static/js/markerclusterer.js"></script>
<script type="text/javascript" src="/static/js/markerwithlabel.js"></script>
<script type="text/javascript">
$(document).ready(function() {
  $('#id_region').addClass('form-control');
  $('#id_gender').addClass('form-control');
  $('#id_year').addClass('form-control');

  $('#id_region').multiselect({
    buttonWidth: '100%',
    includeSelectAllOption: true,
    selectAllText: '{% trans "Seleccionar todos" %}',
    buttonText: function(options, select) {
      if (options.length === 0) {
        return '{% trans "Sin selección ..." %}';
      }
      else if (options.length > 3) {
        return '{% trans "Varias opciones seleccionadas!" %}';
      }
      else {
        var labels = [];
        options.each(function() {
          if ($(this).attr('label') !== undefined) {
            labels.push($(this).attr('label'));
          }
          else {
            labels.push($(this).html());
          }
        });
        return labels.join(', ') + '';
      }
    }
  });


  $('#id_country').multiselect({
    buttonWidth: '100%',
    includeSelectAllOption: true,
    selectAllText: '{% trans "Seleccionar todos" %}',
    buttonText: function(options, select) {
      if (options.length === 0) {
        return '{% trans "Sin selección ..." %}';
      }
      else if (options.length > 3) {
        return '{% trans "Varias opciones seleccionadas!" %}';
      }
      else {
        var labels = [];
        options.each(function() {
          if ($(this).attr('label') !== undefined) {
            labels.push($(this).attr('label'));
          }
          else {
            labels.push($(this).html());
          }
        });
        return labels.join(', ') + '';
      }
    }
  });

  $('#id_province').multiselect({
    buttonWidth: '100%',
    includeSelectAllOption: true,
    selectAllText: '{% trans "Seleccionar todos" %}',
    buttonText: function(options, select) {
      if (options.length === 0) {
        return '{% trans "Sin selección ..." %}';
      }
      else if (options.length > 3) {
        return '{% trans "Varias opciones seleccionadas!" %}';
      }
      else {
        var labels = [];
        options.each(function() {
          if ($(this).attr('label') !== undefined) {
            labels.push($(this).attr('label'));
          }
          else {
            labels.push($(this).html());
          }
        });
        return labels.join(', ') + '';
      }
    }
  });

  $('#id_county').multiselect({
    buttonWidth: '100%',
    includeSelectAllOption: true,
    selectAllText: '{% trans "Seleccionar todos" %}',
    buttonText: function(options, select) {
      if (options.length === 0) {
        return '{% trans "Sin selección ..." %}';
      }
      else if (options.length > 3) {
        return '{% trans "Varias opciones seleccionadas!" %}';
      }
      else {
        var labels = [];
        options.each(function() {
          if ($(this).attr('label') !== undefined) {
            labels.push($(this).attr('label'));
          }
          else {
            labels.push($(this).html());
          }
        });
        return labels.join(', ') + '';
      }
    }
  });

  $('#id_community').multiselect({
    buttonWidth: '100%',
    includeSelectAllOption: true,
    selectAllText: '{% trans "Seleccionar todos" %}',
    buttonText: function(options, select) {
      if (options.length === 0) {
        return '{% trans "Sin selección ..." %}';
      }
      else if (options.length > 3) {
        return '{% trans "Varias opciones seleccionadas!" %}';
      }
      else {
        var labels = [];
        options.each(function() {
          if ($(this).attr('label') !== undefined) {
            labels.push($(this).attr('label'));
          }
          else {
            labels.push($(this).html());
          }
        });
        return labels.join(', ') + '';
      }
    }
  });

  $("#id_country").multiselect('disable');
  $("#id_province").multiselect('disable');
  $("#id_community").multiselect('disable');

  // country
  var region = [];
  $(document).on('change','#id_region',function(){
    // var region = $('#id_region :selected').val();
    $('#id_region :selected').each(function(i, selected){
      region[i] = $(selected).val();
      $('#id_country').multiselect('rebuild');
    });
    $.getJSON('/ajax/countries/?ids='+region.join(","), function(data){
      $('#id_country').html('');
      $("#id_country").multiselect('enable');
      $("#id_country").multiselect('refresh');
      if(data){
        $.each(data, function(i, item){
          $('#id_country').append($('<option></option>').val(item.id).html(item.name));
        });
        $('#id_country').multiselect('rebuild');
      }
    });

  });

  //province
  var foo = [];
  $(document).on('change','#id_country',function(){
    $('#id_country :selected').each(function(i, selected){
      foo[i] = $(selected).val();
      $('#id_province').multiselect('rebuild');
    });
    $.getJSON('/ajax/provinces/?ids='+foo.join(","), function(data){
      $('#id_province').html('');
      $('#id_province').multiselect('enable');
      $("#id_province").multiselect('refresh');
      var province = $('#id_province');
      if(data){
        $.each(data, function(i, item){
          $.each(item, function(j, item2){
            var group = $('<optgroup></optgroup>').attr('label', j);
            $.each(item2, function(k, item3){
              group.append($('<option></option>').val(item3.id).html(item3.name));
            });
            group.appendTo(province);
            $('#id_province').multiselect('rebuild');
          });
        });
      }
    });
  });

  //community
  var foo2 = [];
  $(document).on('change','#id_province',function(){
    $('#id_province :selected').each(function(i, selected){
      foo2[i] = $(selected).val();
      $('#id_community').multiselect('rebuild');
    });
    $.getJSON('/ajax/communities/?ids='+foo2.join(","), function(data){
      $("#id_community").html('');
      $("#id_community").multiselect('enable');
      $("#id_community").multiselect('refresh');
      var community = $('#id_community')
      if(data){
        $.each(data, function(i, item){
          $.each(item, function(j, item2){
            var group = $('<optgroup></optgroup>').attr('label', j);
            $.each(item2, function(k, item3){
              group.append($('<option></option>').val(item3.id).html(item3.name));
            });
            group.appendTo(community);
            $('#id_community').multiselect('rebuild');
          });
        });
      }
    });
  });

});
</script>
<script type="text/javascript" src="/static/js/markerclusterer.js"></script>
<script type="text/javascript">
$( ".map" ).hide();
$(document).on('change','#select-pais',function() {
  var id = $(this).val();
  $.ajax({
    url: '/map/',
    type: 'GET',
    data: {'id' : id},
    success : function(data){
      var i = 0;
      var map;
      // console.log(data[0][0],data[0][1],data[0][3]);
      var latlng = new google.maps.LatLng(data[0][0],data[0][1]);

      function initialize() {
        var myOptions = {
          zoom: 4,
          center: latlng,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          panControl: false,
          zoomControl: false,
          scaleControl: false,
        };

        map = new google.maps.Map(document.getElementById("map_canvas"),myOptions);

        $.each(data, function (index, item) {
          $.each(item[2], function (i, item2) {
            var contentString = '<div id="content">'+
            '<div id="siteNotice">'+
            '</div>'+
            '<h1 id="firstHeading" class="firstHeading">'+i+'</h1>'+
            '<div id="bodyContent">'+
            // '<p>{% trans "Población" %}: '+item2[2]+' </p>' +
            '</div>'+
            '</div>';
            var infowindow = new google.maps.InfoWindow({
              content: contentString
            });
            var marker = new google.maps.Marker({
              position: new google.maps.LatLng(item2[0], item2[1]),
              map: map,
              title: ''+i+'',
            });
            marker.addListener('click', function() {
              infowindow.open(map, marker);
            });
          });

        });
      }
      initialize();
      $( "#fake-map" ).hide();
      $( ".map" ).show();
      $('#select-pais').on('click', function(e) {
        google.maps.event.trigger(map_canvas, 'resize');
        map.setCenter(latlng);
      });
    }
  });
});
</script>
{% endblock %}
